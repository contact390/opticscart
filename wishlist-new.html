<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hitaishi Lens - Wishlist</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
    }

    .navbar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 40px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navbar h1 {
      font-size: 24px;
    }

    .navbar a {
      background: white;
      color: #667eea;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s;
    }

    .navbar a:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      border-radius: 10px;
    }

    .header h2 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 16px;
      opacity: 0.9;
    }

    .wishlist-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .wishlist-card {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }

    .wishlist-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .wishlist-image {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .wishlist-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .wishlist-info {
      padding: 20px;
    }

    .wishlist-brand {
      color: #667eea;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .wishlist-name {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      margin-bottom: 10px;
    }

    .wishlist-price {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 15px;
    }

    .wishlist-actions {
      display: flex;
      gap: 10px;
    }

    .btn-buy {
      flex: 1;
      background: #667eea;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-buy:hover {
      background: #764ba2;
      transform: translateY(-2px);
    }

    .btn-remove {
      flex: 1;
      background: #e74c3c;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-remove:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .empty-state p {
      color: #666;
      font-size: 18px;
      margin-bottom: 20px;
    }

    .empty-state a {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 12px 30px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s;
    }

    .empty-state a:hover {
      background: #764ba2;
      transform: translateY(-2px);
    }

    .alert {
      padding: 15px 20px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }

    .alert.active {
      display: block;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* Buy Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 10px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      position: relative;
    }

    .modal-header {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #333;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
    }

    .close-btn:hover {
      color: #333;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #667eea;
      margin-bottom: 8px;
      font-size: 13px;
      text-transform: uppercase;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 5px;
      font-family: inherit;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #f0f0f0;
    }

    .btn-cancel {
      background: #e0e0e0;
      color: #333;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-cancel:hover {
      background: #d0d0d0;
    }

    .btn-checkout {
      background: #667eea;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-checkout:hover {
      background: #764ba2;
    }

    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        gap: 15px;
      }

      .header {
        padding: 20px;
      }

      .header h2 {
        font-size: 24px;
      }

      .wishlist-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <h1>üï∂Ô∏è Hitaishi Lens</h1>
    <a href="products.html">‚Üê Back to Shop</a>
  </div>

  <div class="container">
    <div class="header">
      <h2>üíñ Your Wishlist</h2>
      <p>Items you love from Hitaishi Lens</p>
    </div>

    <div class="alert alert-success" id="successAlert"></div>
    <div class="alert alert-error" id="errorAlert"></div>

    <div id="loadingState" class="loading">
      <div class="loading-spinner"></div>
      <p>Loading your wishlist...</p>
    </div>

    <div id="wishlistGrid" class="wishlist-grid" style="display: none;"></div>

    <div id="emptyState" class="empty-state" style="display: none;">
      <p>üíî Your wishlist is empty</p>
      <a href="products.html">Continue Shopping</a>
    </div>
  </div>

  <!-- Buy Now Modal -->
  <div class="modal" id="buyModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeBuyModal()">&times;</button>
      <div class="modal-header">Complete Your Order</div>
      <form id="buyForm" onsubmit="submitOrder(event)">
        <input type="hidden" id="selectedProductId">
        <input type="hidden" id="selectedProductName">
        <input type="hidden" id="selectedProductPrice">
        <input type="hidden" id="selectedProductImage">

        <div class="form-group">
          <label>Product</label>
          <input type="text" id="productDisplay" readonly style="background: #f5f5f5;">
        </div>

        <div class="form-group">
          <label>Your Name *</label>
          <input type="text" id="customerName" required>
        </div>

        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="customerEmail" required>
        </div>

        <div class="form-group">
          <label>Phone *</label>
          <input type="tel" id="customerPhone" required>
        </div>

        <div class="form-group">
          <label>Shipping Address *</label>
          <textarea id="customerAddress" required></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" onclick="closeBuyModal()">Cancel</button>
          <button type="submit" class="btn-checkout">Place Order</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let wishlistItems = [];

    async function loadWishlist() {
      try {
        const response = await fetch('http://localhost:5000/api/wishlist');
        const data = await response.json();

        if (data.success && Array.isArray(data.items)) {
          wishlistItems = data.items;
          displayWishlist(wishlistItems);
        } else {
          showEmpty();
        }
      } catch (error) {
        console.error('Error loading wishlist:', error);
        showEmpty();
        showError('Failed to load wishlist');
      }
    }

    function displayWishlist(items) {
      const grid = document.getElementById('wishlistGrid');
      const loading = document.getElementById('loadingState');
      const empty = document.getElementById('emptyState');

      if (items.length === 0) {
        grid.style.display = 'none';
        loading.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      grid.innerHTML = items.map(item => `
        <div class="wishlist-card">
          <div class="wishlist-image">
            ${item.image_url ? 
              `<img src="http://localhost:5000${item.image_url}" alt="${item.product_name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22250%22 height=%22200%22%3E%3Crect fill=%22%23ccc%22 width=%22250%22 height=%22200%22/%3E%3C/svg%3E'">` 
              : '<div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; color: white;">No Image</div>'
            }
          </div>
          <div class="wishlist-info">
            <div class="wishlist-brand">${item.brand}</div>
            <div class="wishlist-name">${item.product_name}</div>
            <div style="font-size: 12px; color: #999; margin-bottom: 8px;">
              ${item.frame_material ? `Frame: ${item.frame_material} | ` : ''}${item.coating_type ? `Coating: ${item.coating_type}` : ''}
            </div>
            <div class="wishlist-price">‚Çπ${parseFloat(item.price).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
            <div class="wishlist-actions">
              <button class="btn-buy" onclick="openBuyModal(${item.product_id}, '${item.product_name}', ${item.price}, '${item.image_url}')">üõí Buy Now</button>
              <button class="btn-remove" onclick="removeFromWishlist(${item.product_id})">‚ùå Remove</button>
            </div>
          </div>
        </div>
      `).join('');

      grid.style.display = 'grid';
      loading.style.display = 'none';
      empty.style.display = 'none';
    }

    function showEmpty() {
      document.getElementById('wishlistGrid').style.display = 'none';
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
    }

    async function removeFromWishlist(productId) {
      if (!confirm('Are you sure you want to remove this item from your wishlist?')) return;

      try {
        const response = await fetch(`http://localhost:5000/api/wishlist/remove/${productId}`, {
          method: 'DELETE'
        });
        const data = await response.json();

        if (data.success) {
          showSuccess('Removed from wishlist');
          wishlistItems = wishlistItems.filter(item => item.product_id !== productId);
          displayWishlist(wishlistItems);
        } else {
          showError(data.error || 'Failed to remove item');
        }
      } catch (error) {
        console.error('Error removing item:', error);
        showError('Failed to remove item from wishlist');
      }
    }

    function openBuyModal(productId, productName, price, imageUrl) {
      document.getElementById('selectedProductId').value = productId;
      document.getElementById('selectedProductName').value = productName;
      document.getElementById('selectedProductPrice').value = price;
      document.getElementById('selectedProductImage').value = imageUrl;
      document.getElementById('productDisplay').value = `${productName} - ‚Çπ${parseFloat(price).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('buyModal').classList.add('active');
    }

    function closeBuyModal() {
      document.getElementById('buyModal').classList.remove('active');
      document.getElementById('buyForm').reset();
    }

    async function submitOrder(e) {
      e.preventDefault();

      const productId = parseInt(document.getElementById('selectedProductId').value);
      const name = document.getElementById('customerName').value.trim();
      const email = document.getElementById('customerEmail').value.trim();
      const phone = document.getElementById('customerPhone').value.trim();
      const address = document.getElementById('customerAddress').value.trim();
      const price = parseFloat(document.getElementById('selectedProductPrice').value);

      if (!name || !email || !phone || !address) {
        showError('Please fill in all fields');
        return;
      }

      try {
        const response = await fetch('http://localhost:5000/api/checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            customer: {
              name,
              email,
              phone,
              address
            },
            items: [{
              id: productId,
              name: document.getElementById('selectedProductName').value,
              price,
              quantity: 1
            }]
          })
        });

        const data = await response.json();

        if (data.success) {
          showSuccess(`‚úÖ Order placed successfully! Order ID: ${data.orderId}`);
          closeBuyModal();
          await removeFromWishlist(productId);
          setTimeout(() => {
            window.location.href = 'trackorder.html';
          }, 2000);
        } else {
          showError(data.error || 'Failed to place order');
        }
      } catch (error) {
        console.error('Error placing order:', error);
        showError('Failed to place order. Please try again.');
      }
    }

    function showSuccess(message) {
      const alert = document.getElementById('successAlert');
      alert.textContent = message;
      alert.classList.add('active');
      setTimeout(() => alert.classList.remove('active'), 3000);
    }

    function showError(message) {
      const alert = document.getElementById('errorAlert');
      alert.textContent = message;
      alert.classList.add('active');
      setTimeout(() => alert.classList.remove('active'), 3000);
    }

    // Close modal when clicking outside
    document.getElementById('buyModal').addEventListener('click', function(e) {
      if (e.target === this) closeBuyModal();
    });

    // Load wishlist on page load
    loadWishlist();
  </script>
</body>
</html>
